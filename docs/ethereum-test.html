<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Puma Ethereum API Test</title>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="puma-eth-sig-util.js"></script>

    <script>
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        window.APITests = {}

        window.APITests.storeResults = {
            "eth_chainID": "",
            "personal_sign" : ""
        }

        window.APITests.differentResults = [
            "eth_blockNumber",
            "eth_gasPrice"
        ]

        window.APITests.checkForSuccessOnly = [
            "eth_newBlockFilter",
            "eth_newFilter",
            "eth_newPendingTransactionFilter",
            "eth_getLogs",
            "web3_clientVersion"
        ]

        //this methods need parameters, so should return 32602
        window.APITests.errorTests = {
            "eth_call":[], 
            "eth_estimateGas":[],
            "eth_feeHistory":[],
            "eth_getBalance":[],
            "eth_getBlockByHash":[],
            "eth_getBlockByNumber":[],
            "eth_getBlockTransactionCountByHash":[],
            "eth_getBlockTransactionCountByNumber":[],
            "eth_getCode":[],
            "eth_getProof":[],
            "eth_getStorageAt":[],
            "eth_getTransactionByBlockHashAndIndex":[],
            "eth_getTransactionByBlockNumberAndIndex":[],
            "eth_getTransactionByHash":[],
            "eth_getTransactionCount":[],
            "eth_getTransactionReceipt":[],
            "eth_getUncleByBlockHashAndIndex":[],
            "eth_getUncleByBlockNumberAndIndex":[],
            "eth_getUncleCountByBlockHash":[],
            "eth_getUncleCountByBlockNumber":[],
            "web3_sha":[]
        }

        //this are handeled differently my metamask
        window.APITests.filterTests = [
            "eth_getFilterChanges",
            "eth_getFilterLogs",
            "eth_uninstallFilter"
        ]

        window.APITests.transactionTests = {
            "eth_sendRawTransaction":[],
            "eth_sendTransaction":[],
        }

        window.APITests.onlyEthereumTests = [
            "eth_accounts",
            "eth_coinbase",
            "eth_decrypt",
            "eth_getEncryptionPublicKey",
            "eth_sign",
            "eth_signTypedData_v3",
            "eth_signTypedData_v4",
            "metamask_getProviderState",
            "personal_sign",
            "personal_ecRecover"
        ]

       

        //key - rpc method
        //value - parameters
        window.APITests.tests = {
            "eth_blockNumber":[],
            "eth_call":[{to: "0xccf20531fe0d10740e9de0f11cc57d91f833e6de",
                         data: "0xd1bbd49c"},
                        "latest"],
            "eth_chainId":[],
            "eth_compileLLL":[],
            "eth_compileSerpent":[],
            "eth_compileSolidity":[],
            "eth_estimateGas":[{'maxPriorityFeePerGas': '0x9502f900','value': '0x5af3107a4000','from': '0x092c565e1360ba2bd37e6772102f15aa184567bd','data': '0x3f33133a00000000000000000000000000000000000000000000000000005af3107a4000000000000000000000000000092c565e1360ba2bd37e6772102f15aa184567bd000000000000000000000000092c565e1360ba2bd37e6772102f15aa184567bd00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000','maxFeePerGas': '0x9502f910','to': '0xccf20531fe0d10740e9de0f11cc57d91f833e6de'}],
            "eth_feeHistory":["0x5", "earliest", []],
            "eth_gasPrice":[],
            "eth_getBalance":[],
            "eth_getBlockByHash":["0x4dcd3e18613ef8b05d78a40255b59eec308b8bf1b874fc3c1596ae0eadf8449a",false],
            "eth_getBlockByNumber":["earliest", false],
            "eth_getBlockTransactionCountByHash":["0x4dcd3e18613ef8b05d78a40255b59eec308b8bf1b874fc3c1596ae0eadf8449a"],
            "eth_getBlockTransactionCountByNumber":["earliest"],
            "eth_getCode":["","latest"],
            "eth_getCompilers":[],
            "eth_getLogs":[],
            "eth_getProof":["0x54705167f67a4960200b2fb8d99ae576d83e8b22",["0x0000000000000000000000000000000000000000000000000000000000000000"],"latest"],
            "eth_getStorageAt":[],
            "eth_getTransactionByBlockHashAndIndex":["0x4dcd3e18613ef8b05d78a40255b59eec308b8bf1b874fc3c1596ae0eadf8449a","0x0"],
            "eth_getTransactionByBlockNumberAndIndex":["earliest","0x0"],
            "eth_getTransactionByHash":["0x6551b486b338dc3796afcaa76c56a90a7e300b82d24630afe2daab42d1f9ab94"],
            "eth_getTransactionCount":[],
            "eth_getTransactionReceipt":["0x6551b486b338dc3796afcaa76c56a90a7e300b82d24630afe2daab42d1f9ab94"],
            "eth_getUncleByBlockHashAndIndex":["0x4dcd3e18613ef8b05d78a40255b59eec308b8bf1b874fc3c1596ae0eadf8449a","0x0"],
            "eth_getUncleByBlockNumberAndIndex":[ "earliest","0x0"],
            "eth_getUncleCountByBlockHash":["0x4dcd3e18613ef8b05d78a40255b59eec308b8bf1b874fc3c1596ae0eadf8449a"],
            "eth_getUncleCountByBlockNumber":["earliest"],
            "eth_getWork":[],
            "eth_hashrate":[],
            "eth_mining":[],
            "eth_newBlockFilter":[],
            "eth_newFilter":[],
            "eth_newPendingTransactionFilter":[],
            "eth_protocolVersion":[],
            "eth_submitHashrate":[],
            "eth_submitWork":[],
            "eth_syncing":[],
            "net_listening":[],
            "net_peerCount":[],
            "net_version":[],
            "shh_addToGroup":[],
            "shh_getFilterChanges":[],
            "shh_getMessages":[],
            "shh_hasIdentity":[],
            "shh_newFilter":[],
            "shh_newGroup":[],
            "shh_newIdentity":[],
            "shh_post":[],
            "shh_uninstallFilter":[],
            "shh_version":[],
            "web3_clientVersion":[],
            "web3_sha3":["0x68656c6c6f20776f726c64"]
    }

    

    function statusAndLog(message){
        addToLog(message)
        updateStatus(message)
    }

    function addToLog(message){
        var container = document.getElementById("log")
        container.innerText = container.innerText + 
            message + '\n';
    }

    function updateStatus(message){
        document.getElementById("logging").style.display = "block"
        var container = document.getElementById("status")
        container.innerText =  message;
    }

    function setupConnections(){
        //check inputs
        window.APITests.node = document.getElementById("node").value
        window.APITests.pk = document.getElementById("pk").value

        if( window.APITests.address == "" || window.APITests.pk == "" ){
            document.getElementById("inputs").innerHTML = 
                "<p> Please enter node address and primary key of the test account</p>" +
                document.getElementById("inputs").innerHTML
                return false
        }
        
        if ( !window.ethereum ){
            document.getElementById("inputs").innerHTML = 
                "<p> window.ethereum is not defined. </p>" +
                document.getElementById("inputs").innerHTML
                return false
        }

        if ( window.Web3 ){
            statusAndLog(`web3 setup with "${window.APITests.node}"`)
            window.APITests.web3 = new window.Web3(window.APITests.node);
            window.APITests.account = window.APITests.web3.eth.accounts.privateKeyToAccount(window.APITests.pk);
            window.APITests.tests.eth_getBalance = [window.APITests.account.address, "latest"]
            window.APITests.tests.eth_getCode = [window.APITests.account.address,"latest"]
            //window.APITests.tests.eth_getProof = [window.APITests.account.address,["0x0000000000000000000000000000000000000000000000000000000000000000"],"latest"]
            window.APITests.tests.eth_getStorageAt = [window.APITests.account.address,"0x0", "latest"]
            window.APITests.tests.eth_getTransactionCount = [window.APITests.account.address, "latest"]
        }else{
            document.getElementById("inputs").innerHTML = 
                "<p> Web 3 is not loaded, give it a moment </p>" +
                document.getElementById("inputs").innerHTML
                return false
        }

        document.getElementById("inputs").style.display = "none"
        

        return true
    }

    function runWeb3(func,params){
        statusAndLog(`running ${func} with ${JSON.stringify(params)} on web3`)
        window.APITests.web3Result = ""
        window.APITests.ethereumResult = ""
        window.APITests.web3.currentProvider.send({
            method: func,
            params: params,
            jsonrpc: "2.0",
            id: new Date().getTime()
            },
            function (error, result){
                if( error ){
                    addToLog("web3 error:" + JSON.stringify(error))
                    statusAndLog("web3 error")
                    window.APITests.web3Result = error["error"]
                    window.APITests.web3Success = false
                }else {
                    if (typeof result["result"] !== 'undefined'){
                        window.APITests.web3Result = result["result"]
                    }else{
                        window.APITests.web3Result = result["error"]
                    }
                    addToLog("web3 result:" + JSON.stringify(result))
                    statusAndLog("web3 success")
                    window.APITests.web3Success = true
                }
                window.APITests.web3Running = false
                
            }
        )
    }

    function runEthereum(func, params){
        statusAndLog(`running ${func} with ${JSON.stringify(params)} on ethereum`)
        window.ethereum.request({ method: func, params: params }).then(
            function (result){
                addToLog("ethereum result:" + JSON.stringify(result))
                statusAndLog("ethereum success")
                window.APITests.ethereumResult = result
                window.APITests.ethereumRunning = false
                window.APITests.ethereumSuccess = true
            },
            function (error){
                addToLog("ethereum error:" + JSON.stringify(error))
                statusAndLog("ethereum error")
                window.APITests.ethereumRunning = false
                window.APITests.ethereumResult = error
                window.APITests.ethereumSuccess = false
            }
        )
    }

    function wait({code,ms,check,message= "", count = 0}){
        setTimeout(() => {
            if(!check()){
                statusAndLog(`waiting (${message}), count is ${count}` )
                count++
                wait({code,ms,check,message, count})
            }else{
                code()
            }
        }
        ,ms)
    }

    function compareResults(func){
        //check for error
        if (typeof window.APITests.ethereumResult !== "undefined"  && 
            typeof window.APITests.web3Result !== "undefined" && 
            window.APITests.ethereumResult != null  && 
            window.APITests.web3Result != null){
            if (typeof window.APITests.ethereumResult.code !== "undefined" && 
                typeof window.APITests.web3Result.code !== "undefined"){
                if (window.APITests.ethereumResult.code == window.APITests.web3Result.code){  
                    statusAndLog(func + ": results are the same")
                    addToLog("")
                    return
                }
            }
        }

        if (Object.keys(window.APITests.storeResults).includes(func)){
            window.APITests.storeResults[func] = window.APITests.ethereumResult
        }

        //handle cases where results can be a bit off like block number and gas price
        if (window.APITests.differentResults.includes(func)){
            var web3Data = window.APITests.web3.utils.hexToNumber(window.APITests.web3Result)
            var ethereumData = window.APITests.web3.utils.hexToNumber(window.APITests.ethereumResult)
            if (web3Data < ethereumData){
                //10% offset
                if (web3Data > ethereumData * 0.9){
                    statusAndLog(func + ": results within bounds")
                    addToLog("")
                    return
                }
            }else{
                //10% offset
                if (web3Data * 0.9 < ethereumData){
                    statusAndLog(func + ": results within bounds")
                    addToLog("")
                    return
                }
            }

        }

        if (window.APITests.checkForSuccessOnly.includes(func)){
            if (window.APITests.ethereumSuccess == window.APITests.web3Success){
                statusAndLog(func + ": results are the same")
                addToLog("")
                return
            }
        }


        if (Array.isArray(window.APITests.web3Result) && Array.isArray(window.APITests.ethereumResult)){
            var web3string = JSON.stringify( window.APITests.web3Result.sort)
            var ethString = JSON.stringify(window.APITests.ethereumResult.sort)
            if ( web3string == ethString){
                statusAndLog(func + ": results are the same")
            addToLog("")
                return
            }
        }else if(typeof(window.APITests.ethereumResult) == "object" &&
                 typeof(window.APITests.web3Result) == "object"){
            var web3string = JSON.stringify(window.APITests.web3Result)
            var ethString = JSON.stringify(window.APITests.ethereumResult)
            if ( web3string == ethString){
                statusAndLog(func + ": results are the same")
                addToLog("")
                return
            }

        }

        //all other cases
        if ( window.APITests.ethereumResult  == window.APITests.web3Result){
            statusAndLog(func + ": results are the same")
            addToLog("")
        }else{
            statusAndLog(func + ": results are the not the same")
            window.APITests.testFailed = true
        }
                        
    }

    function runTest(func,params){
        window.APITests.web3Running = true
        runWeb3(func,params)

        wait({
            code: () => {
                window.APITests.ethereumRunning = true
                runEthereum(func, params)
                wait({
                    code: () => {
                        compareResults(func)
                        window.APITests.testRunning = false
                    },
                    ms: 1000,
                    check: () => {return window.APITests.ethereumRunning == false },
                    message: `${func} on ethereum`
                })
            },
            ms: 1000,
            check: () => {return window.APITests.web3Running == false },
            message: `${func} on web 3`
        })

    }

    function setupTestData(){
        /*var callCount = 1
        window.ethereum.request(
            {method :"eth_newFilter",
             params: [{from:10351344, to: 10351344, address: "0x8888f1f195afa192cfee860698584c030f4c9db1" }]}).then(
                function (result){
                    callCount -= 1

                },
             )
        wait({
            code: () => {
                window.APITests.setupDone = true
            },
            ms: 5000,
            check: () => {return callCount == 0 },
            message:"setting things up"
        })*/
        
        window.APITests.setupDone = true
    }

    function test(){
        if ( !setupConnections() ){
            //add entered values back to the fields
            document.getElementById("node").value = window.APITests.address
            document.getElementById("pk").value = window.APITests.pk
            updateStatus("setup failed")
            //return
        }

        window.APITests.setupDone = false
        setupTestData()

        wait({
            code: () => {
                statusAndLog("starting tests")

                window.APITests.testFailed = false
                window.APITests.testRunning = false

                mainLoop(0,window.APITests.tests, "main batch")
                wait({
                    code: () => {
                        statusAndLog("starting tests")

                        window.APITests.testFailed = false
                        window.APITests.testRunning = false
                        
                        window.APITests.testGroupDone = false
                        mainLoop(0,window.APITests.errorTests,"errors testing")
                    },
                    ms: 5000,
                    check: () => {return window.APITests.testGroupDone == true },
                    message:"main"
                })
            },

            ms: 5000,
            check: () => {return window.APITests.setupDone == true },
            message:"main"
        })
    }

    function mainLoop(count, tests, name){
        wait({
            code: () => {
                if( count >= Object.keys(tests).length ){
                    window.APITests.testGroupDone = true
                    statusAndLog("done " + name)
                    return
                }
                if(  window.APITests.testFailed == true){
                    return
                }
                document.getElementById("testCount").innerHTML = `On test ${ (count + 1 )}/${Object.keys(tests).length}`
                var func = Object.keys(tests).sort()[count]
                var params = tests[func]
                window.APITests.testRunning = true
                runTest(func,params)
                mainLoop(count+1,tests, name)
            },
            ms: 5000,
            check: () => {return window.APITests.testRunning == false },
            message:"main"
        })
    }

    function runEthereumOnlyTests(count){
        var func = window.APITests.onlyEthereumTests[count]

        var params = [];
        switch(func) {
            case "eth_sign":
                params = [window.APITests.account.address, window.APITests.web3.utils.toHex("Hello World from Puma wallet API")]
                break;
            case "eth_signTypedData_v3", "eth_signTypedData_v4":
                params = [window.APITests.account.address,
                    JSON.stringify({types: {
                    EIP712Domain: [
                        { name: 'name', type: 'string' },
                        { name: 'version', type: 'string' },
                        { name: 'chainId', type: 'uint256' },
                        { name: 'verifyingContract', type: 'address' },
                        { name: 'salt', type: 'bytes32' },
                    ],
                    testData: [{name: 'testString', type: 'string'}],
                    },
                    domain: {
                    name: 'Puma Test',
                    version: '1',
                    chainId: window.APITests.storeResults["eth_chainId"],
                    verifyingContract: window.APITests.account.address,
                    salt: "0x43efba6b4ccb1b6faa2625fe562bdd9a23260359"
                    },
                    primaryType: 'testData',
                    message: {testString: "Hello World"}
                })]
                break;
            case "personal_ecRecover":
                params = ["0x4920616d207369676e696e6720746865206d6574616461746120666f7220746865206c6f636b20617420307863636632303533316665304431303734306539646530663131434335374439314638333365366445",
                window.APITests.storeResults["personal_sign"]
                ]
                break;  
            case "personal_sign":
                params = [
                    window.APITests.account.address,
                    "0x4920616d207369676e696e6720746865206d6574616461746120666f7220746865206c6f636b20617420307863636632303533316665304431303734306539646530663131434335374439314638333365366445"
                ]
                break;  
        
        }

        window.APITests.ethereumRunning = true
        runEthereum(func, params)
        wait({
            code: () => {
                checkEthereumResults(func)
            },
            ms: 1000,
            check: () => {return window.APITests.ethereumRunning == false },
            message: `${func} on ethereum`
        })


    }
    /*
            "eth_accounts",
            "eth_coinbase",
            "eth_decrypt",
            "eth_getEncryptionPublicKey",
            "eth_sign",
            "eth_signTypedData_v3",
            "eth_signTypedData_v4",
            "metamask_getProviderState",
            "personal_sign",
            "personal_ecRecover"
    */

    function checkEthereumResults(func){
        switch(func) {
            case "eth_sign":
                var privateKey = document.ethSigUtil.toBuffer(window.APITests.pk)
                var signature = document.ethSigUtil.personalSign({privateKey, data})

                break;
            case "eth_signTypedData_v3", "eth_signTypedData_v4":
                
                break;
            case "personal_ecRecover":

                break;
            case "personal_sign":
                
                break;  
        
        }
    }


  </script>

  <style>
    body{
      font-family:sans-serif;
    }

    pre.container{
      background-color:lightgreen;
      padding:10px;
    }

    .error{
      display:none;
      background-color:pink;
      padding:10px;
    }
  </style>

</head>

<body>

<div id="inputs">
    
    <p>It is advised to use test network and test account as some transactions use up gas</p>
    <p>Node address: <input type="text" id="node" size="90%"/> </p>
    <p>For tests to work, make sure you are logged into wallet with the same PK</p>
    <p>PK to use: <input type="text" id="pk" size="90%"/> </p>
    <p><input type="button" value="start tests" onclick="test()"/></p>

</div>

<div id="logging" style="display: none;">
<div  id="testCount"> </div>
<p>Current test status</p>
<div id="status"></div>
<br>
<p>Log:</p>
<div id="log"></div>
</div>
</body> 
</html>
